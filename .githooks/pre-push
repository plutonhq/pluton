#!/usr/bin/env sh

set -eu

run_tests=0

while read -r local_ref local_sha remote_ref remote_sha
do
  if [ "${remote_ref}" = "refs/heads/main" ]; then
    if [ "${local_sha}" != "0000000000000000000000000000000000000000" ]; then
      run_tests=1
      break
    fi
  fi
done

if [ "$run_tests" -eq 0 ]; then
  exit 0
fi

echo "[pre-push] Pushing to main. Running backend lint, test, and build..."

echo "[pre-push] Running lint..."
pnpm --filter @plutonhq/core-backend lint

echo "[pre-push] Running tests..."
pnpm --filter @plutonhq/core-backend test

echo "[pre-push] Running build..."
pnpm --filter @plutonhq/core-backend build

echo "[pre-push] All checks passed. Continuing push."