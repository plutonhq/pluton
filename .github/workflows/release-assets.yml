name: Build Release Assets

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to build (e.g., v0.0.1)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-linux:
    name: Build Linux Assets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - uses: pnpm/action-setup@v2
        with:
          version: 10.20.0

      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install AppImage dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2 file

      - name: Build Executables and Tarballs
        run: node scripts/build-executables.js --platform linux

      - name: Build AppImage
        run: |
          chmod +x installers/linux/build-appimage.sh
          bash installers/linux/build-appimage.sh

      - name: Upload Executables Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pluton-executables
          path: dist/executables
          retention-days: 1

      - name: Upload Linux Assets
        if: ${{ !env.ACT }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          files: |
            dist/installers/*.tar.gz
            dist/installers/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows Assets
    runs-on: windows-latest
    environment: ci
    env:
      TSA_URL: http://timestamp.digicert.com
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 10.20.0

      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      # Setup Google Cloud SDK ---
      - id: "auth"
        name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_CREDENTIALS_JSON }}"

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      # Setup Jsign and Certificate ---
      - name: Setup Code Signing Tools
        run: |
          # 1. Download Jsign JAR (Runs on any machine with Java, which windows-latest has)
          curl -L -o jsign.jar https://github.com/ebourg/jsign/releases/download/6.0/jsign-6.0.jar

          # 2. Decode the certificate from secrets to a file
          $certBytes = [System.Convert]::FromBase64String("${{ secrets.SIGNING_CERT_BASE64 }}")
          [System.IO.File]::WriteAllBytes("certificate.crt", $certBytes)

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Inno Setup
        run: choco install innosetup

      - name: Build Executables
        run: node scripts/build-executables.js --platform windows

      # Sign the main executable BEFORE packaging
      # This ensures the .exe inside "Program Files" is trusted
      - name: Sign Main Executable
        shell: powershell
        run: |
          # Get Google Access Token
          $Token = gcloud auth print-access-token

          # Path to the built executable (Adjust if build-executables.js outputs elsewhere)
          $ExePath = "dist\executables\pluton-win-x64\pluton.exe"

          echo "Signing $ExePath..."

          java -jar jsign.jar `
            --storetype GOOGLECLOUD `
            --storepass "$Token" `
            --keystore "${{ secrets.GCP_KMS_KEYRING }}" `
            --alias "${{ secrets.GCP_KMS_KEY_ALIAS }}" `
            --certfile "certificate.crt" `
            --tsaurl "${{ env.TSA_URL }}" `
            "$ExePath"

      - name: Build Windows Installer
        run: node installers/windows/build-installer.js

      # Sign the final Installer ---
      # This ensures SmartScreen trusts the setup file users download
      - name: Sign Installer
        shell: powershell
        run: |
          $Token = gcloud auth print-access-token

          # Find the generated installer (handling potential naming variations)
          $InstallerPath = Get-ChildItem "dist\installers\*.exe" | Select-Object -First 1 -ExpandProperty FullName

          echo "Signing $InstallerPath..."

          java -jar jsign.jar `
            --storetype GOOGLECLOUD `
            --storepass "$Token" `
            --keystore "${{ secrets.GCP_KMS_KEYRING }}" `
            --alias "${{ secrets.GCP_KMS_KEY_ALIAS }}" `
            --certfile "certificate.crt" `
            --tsaurl "${{ env.TSA_URL }}" `
            "$InstallerPath"

      - name: Upload Windows Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          files: |
            dist/installers/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  upload-scripts:
    name: Upload Installer Scripts to R2
    runs-on: ubuntu-latest
    environment: ci
    steps:
      - uses: actions/checkout@v4

      - name: Prepare scripts directory
        run: |
          mkdir -p dist/scripts
          cp installers/linux-server/install.sh dist/scripts/
          cp installers/linux-server/uninstall.sh dist/scripts/

      - name: Upload scripts to R2
        uses: ryand56/r2-upload-action@latest
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET }}
          source-dir: dist/scripts
          destination-dir: server/scripts
          keep-file-fresh: true

  docker:
    name: Build Docker Image
    needs: build-linux
    environment: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Executables Artifact
        uses: actions/download-artifact@v4
        with:
          name: pluton-executables
          path: dist/executables

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual dispatch, use the input tag, stripping 'v' prefix if present
            VERSION="${{ github.event.inputs.tag }}"
          else
            # For release events, GITHUB_REF is like refs/tags/v1.2.3 or refs/tags/pluton-v1.2.3
            # We want just the version number (e.g., 1.2.3)
            VERSION=${GITHUB_REF#refs/tags/}
          fi

          # Strip 'v' prefix if present
          VERSION=${VERSION#v}
          # Strip 'pluton-v' prefix if present (common in monorepos)
          VERSION=${VERSION#pluton-v}

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ !env.ACT }}
          tags: |
            plutonhq/pluton:${{ steps.version.outputs.VERSION }}
            plutonhq/pluton:latest
          build-args: |
            APP_VERSION=${{ steps.version.outputs.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
